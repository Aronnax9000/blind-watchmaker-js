<html>
<head>
<title>Biomorph Breeding</title>
<link rel="stylesheet" type="text/css" href="style.css">
<link rel="stylesheet" type="text/css" href="watchmaker_boxes.css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="html_canvas.js"></script>
<script src="drawing_context.js"></script>
<script src="drawing_context_canvas2d.js"></script>
<script src="drawing_context_nop.js"></script>
<script src="drawing_context_svg.js"></script>

<script src="biomorph_genotype.js"></script>
<script src="watchmaker_geom.js"></script>
<script src="biomorph_pic.js"></script>
<script src="biomorph_develop.js"></script>
<script src="app.js"></script>
<script type="text/javascript">
    var numBoxes = 15;
    function doCanvasClicked(canvasId) {
        var midBox = Math.trunc(numBoxes / 2);
        var midCanvasId = 'canvas' + midBox;
        var midCanvas = document.getElementById(midCanvasId);
        var clickedCanvas = document.getElementById(canvasId);
        if (jQuery.data(clickedCanvas, 'genotype') != null) {
            if (midCanvas != clickedCanvas) {
                jQuery.data(midCanvas, 'genotype', jQuery.data(clickedCanvas,
                        "genotype"));
                develop(jQuery.data(midCanvas, 'genotype'), midCanvas,
                        drawCrossHairs);
            }
            for (i = 0; i < numBoxes; i++) {
                if (i != midBox) {
                    doReproduce(midCanvasId, 'canvas' + i);
                }
            }
        }
    }
    
    function addBoxes(numberOfBoxes) {
        var midBox = Math.trunc(numberOfBoxes / 2);
        console.log("MidBox: " + midBox);
        var midCanvas;
        for (j = 0; j < numberOfBoxes; j++) {
            var div = document.createElement("div");
            var boxId = 'box' + j;
            div.id = boxId;
            div.className = 'box';

            if (j == midBox) {
                div.className += ' midBox';
                console.log("added midbox");
            }
            canvas = make_canvas("canvas" + j);
            if (j == midBox) {
                div.className += ' midBox';
                midCanvas = canvas;
                console.log("added midbox");
            }
            $("#boxes").append(div);
            $("#" + boxId).append(canvas);
            console.log(div.className);

        }
        console.log(midCanvas.id + " wxh " + midCanvas.width + "x"
                + midCanvas.height);
        initialize("BasicTree", 'canvas' + midBox);
        midCanvas.click();
    }

    function startAutoBreeding(numberOfBoxes) {
        autoRunning = true;
        autoBreed(numberOfBoxes);
        measureGenerationRate(Number(document.getElementById('generations').value));
    }

    function fitness(biomorph, targetWidth, targetHeight) {
        var margin = biomorph.pic.margin;
        var marginWidth = margin.right - margin.left;
        var marginHeight = margin.bottom - margin.top;
        var widthError = Math.abs(targetWidth - marginWidth) / targetWidth;
        var heightError = Math.abs(targetHeight - marginHeight) / targetHeight;
        var averageError = (widthError + heightError) / 2;
        return averageError;
    }

    function getBiomorphFromCanvas(canvas) {

        var biomorph = jQuery.data(canvas, 'genotype');
        return biomorph;
    }

    function autoBreed(numberOfBoxes) {
        if (autoRunning) {
            var useFitness = document.getElementById('useFitness').checked;
            if (useFitness) {
                var canvasId = 'canvas0';
                var canvas = document.getElementById(canvasId);
                var biomorph = getBiomorphFromCanvas(canvas);
                var bestSoFar = canvasId;
                var errorToBeat = fitness(biomorph, canvas.width, canvas.height);
                for (i = 1; i < numberOfBoxes; i++) {
                    canvasId = 'canvas' + i;
                    canvas = document.getElementById(canvasId);
                    var currentError = fitness(getBiomorphFromCanvas(canvas),
                            canvas.width, canvas.height);
                    if (currentError < errorToBeat) {
                        bestSoFar = canvasId;
                        errorToBeat = currentError;
                    }
                }
                document.getElementById(bestSoFar).click();
            } else {
                var luckyParent = Math.trunc(Math.random() * numberOfBoxes);
                document.getElementById('canvas' + luckyParent).click();
            }
            setTimeout(function() {
                autoBreed(numberOfBoxes)
            }, Number(document.getElementById("autoReproduceInterval").value));
        }

    }
</script>
</head>
<body onload="addBoxes(numBoxes);">
	<div>
		<button id="autoReproduce" onclick="startAutoBreeding(numBoxes);">Auto
			Reproduce</button>
		<span> with delay of</span> <input type="text"
			id="autoReproduceInterval" size="5" maxlength="10" value="0" />
		milliseconds.
		<button id="stopAutoReproduce" onclick="autoRunning = false;">Stop</button>
	</div>
	<div>
		<input type="checkbox" id="useFitness" />
		<span>Use 'Fitness'
			(Breed based on how well biomorph fits its box)
		<a href="engineering.html">Engineering</a>	
		</span>
	   
	</div>

	<div>
		Generation: <input type="number" value="0" id="generations" />
		Generations per second: <input type="number" value="0"
			id="generationRate" />
	</div>

	<div id="boxes" class="boxes"></div>
</body>
</html>
